stageResultMap = [:]
pipeline {
    options {
        skipDefaultCheckout()
        timestamps()
        disableConcurrentBuilds()
    }
    parameters {
        string(name: 'BUILD_VERSION', defaultValue: '', description: 'The build version to deploy vXXXX.XXXX.X (optional)')
        choice(name: 'DEPLOY_TO', choices: 'test', description: 'The deployment stage to trigger')
    }
    environment {
        PROJECT_NAME = 'aspireprototype'
        ENVIRONMENT = "test"
        ENV = "test"
        INIT_TOKEN   = credentials('Vault-Access')                                   // OIDC provider this token is Auto Generated //
        SPHINX_TOKEN = credentials('ncatssvcdvops-sphinx')                           // PatToken Read Only Access for the DevOps Artifacts Repo https://github.com/Sphinx-Automation/devops-pipeline-artifacts.git //
        ROLE_NAME    = "$ENVIRONMENT-$PROJECT_NAME"
        APP_TYPE     = "api"
    }
    agent {
        node { label 'aicp-test' }
    }
    stages {
        stage('Clean & Clone') {
            steps {
                cleanWs()
                checkout scm
                script {
                sh '''
                    ### Cloning the repo from DevOps Artifacts Repository Repo ###
                    git clone https://$SPHINX_TOKEN@github.com/Sphinx-Automation/devops-pipeline-artifacts.git
                    ls -lrth ./devops-pipeline-artifacts/application
                    ###  Running the script with Env specific to Authenticate Vault & Get Application Secrets for Docker & NpmJS Token###
                    cd devops-pipeline-artifacts/application && /bin/bash getAppSecretsByRole.sh  && /bin/bash getNcatsDockerSecretsByRole.sh && /bin/bash getNpmJsSecretsByRole.sh
                    '''
                }
            }
        }
        stage('Docker login'){
            steps {
               configFileProvider([
                    configFile(fileId: 'prepare.sh', targetLocation: 'prepare.sh')
                ]){
                  sh '''#!/bin/bash
                        source prepare.sh
                        docker login https://registry.ncats.nih.gov:5000 -u "${DOCKERLOGIN}" -p "${DOCKERPASSWORD}"
                    '''
                } 
            }

        }    
        stage('DeployCI') {
            environment {
                   INIT_TOKEN   = credentials('Vault-Access')                                   // OIDC provider this token is Auto Generated //
                   SPHINX_TOKEN = credentials('ncatssvcdvops-sphinx')                           // PatToken Read Only Access for the DevOps Artifacts Repo https://github.com/Sphinx-Automation/devops-pipeline-artifacts.git //
              }
            steps {       
               configFileProvider([
                    configFile(fileId: 'aicp-mfe-visualizer-docker-compose-test.yml', targetLocation: "docker-compose.yml"),
                    configFile(fileId: 'prepare.sh', targetLocation: 'prepare.sh')   
                ]) {
                        withEnv([
                            "PROJECT_NAME=aspireprototype",
                            "ENVIRONMENT=test",
                            "ENV=test",
                            "BUILD_VERSION=" + (params.BUILD_VERSION ?: env.BUILD_VERSION),                          
                            "ROLE_NAME=$ENV-$PROJECT_NAME",
                            "APP_TYPE=api",
                            "DOCKER_REPO_NAME_1=registry.ncats.nih.gov:5000/aicp-mfevisualizer"
                            
                        ]) {
                            script {
                                sh '''#!/bin/bash
                                   source prepare.sh
                                   
                                   docker-compose -p $PROJECT_NAME down -v --rmi all | xargs echo

                                   docker pull $DOCKER_REPO_NAME_1:$BUILD_VERSION
                                   docker tag $DOCKER_REPO_NAME_1:$BUILD_VERSION $DOCKER_REPO_NAME_1:current

                                   docker-compose -p $PROJECT_NAME up -d
                                   docker rmi \$(docker images -aq) | xargs echo
                                '''
                            }
                        }
                    }
                }
            }
        }
    }
